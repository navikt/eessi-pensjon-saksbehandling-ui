#!/usr/bin/env groovy
@Library('jenkins-pipeline-lib') _

node {
    def commitHash
    cleanWs()

    stage("checkout") {
        checkout scm

        commitHash = sh(script: 'git rev-parse HEAD', returnStdout: true).trim()
    }

    stage("build") {
        sh "make"
    }

    stage("release") {
        withCredentials([usernamePassword(credentialsId: 'nexusUploader', usernameVariable: 'NEXUS_USERNAME', passwordVariable: 'NEXUS_PASSWORD')]) {
            sh "docker login -u ${env.NEXUS_USERNAME} -p ${env.NEXUS_PASSWORD} repo.adeo.no:5443"
        }

        sh "make docker-push VERSION=${commitHash}"
    }

    stage("upload manifest") {
        withCredentials([usernamePassword(credentialsId: 'nexusUploader', usernameVariable: 'NEXUS_USERNAME', passwordVariable: 'NEXUS_PASSWORD')]) {
            sh "make manifest VERSION=${commitHash}"
        }
    }

    stage("deploy fss") {
        build([
                job       : 'nais-deploy-pipeline',
                wait      : true,
                parameters: [
                        string(name: 'APP', value: "eessi-pensjon-frontend-ui"),
                        string(name: 'REPO', value: "navikt/eessi-pensjon-frontend-ui"),
                        string(name: 'VERSION', value: "${commitHash}-fss"),
                        string(name: 'DEPLOY_REF', value: "${commitHash}-fss"),
                        string(name: 'DEPLOY_ENV', value: 't8'),
                        string(name: 'NAMESPACE', value: 't8'),
                        string(name: 'CLUSTER', value: 'fss')
                ]
        ])
    }

    stage("deploy sbs") {
        build([
            job       : 'nais-deploy-pipeline',
            wait      : true,
            parameters: [
                string(name: 'APP', value: "eessi-pensjon-frontend-ui"),
                string(name: 'REPO', value: "navikt/eessi-pensjon-frontend-ui"),
                string(name: 'VERSION', value: "${commitHash}-sbs"),
                string(name: 'DEPLOY_REF', value: "${commitHash}-sbs"),
                string(name: 'DEPLOY_ENV', value: 't8'),
                string(name: 'NAMESPACE', value: 't8'),
                string(name: 'CLUSTER', value: 'sbs')
            ]
        ])
    }
}
